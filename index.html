<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>عالم مناسك الملكي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- MediaPipe Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --gold: #fbbf24;
            --royal-bg: #020617;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--royal-bg);
            margin: 0;
            overflow: hidden;
            height: 100vh;
            color: white;
            -webkit-tap-highlight-color: transparent;
        }

        #bg-canvas {
            position: fixed;
            inset: 0;
            z-index: 0;
        }

        /* 3D Box Styling */
        .scene {
            width: 180px;
            height: 180px;
            perspective: 1000px;
            z-index: 10;
        }

        .box-3d {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transform: rotateX(-20deg) rotateY(45deg);
            transition: transform 1s cubic-bezier(0.19, 1, 0.22, 1);
        }

        .box-face {
            position: absolute;
            width: 160px;
            height: 160px;
            background: linear-gradient(135deg, #9f1239, #4c0519);
            border: 2px solid var(--gold);
            box-shadow: inset 0 0 40px rgba(0,0,0,0.8);
        }

        .front  { transform: rotateY(0deg) translateZ(80px); }
        .back   { transform: rotateY(180deg) translateZ(80px); }
        .right  { transform: rotateY(90deg) translateZ(80px); }
        .left   { transform: rotateY(-90deg) translateZ(80px); }
        .top    { transform: rotateX(90deg) translateZ(80px); background: #be123c; }
        .bottom { transform: rotateX(-90deg) translateZ(80px); }

        .box-open { transform: scale(0) rotateX(360deg); opacity: 0; }

        /* Floating Photos */
        .floating-photo {
            position: absolute;
            width: 110px;
            height: 155px;
            border: 2px solid var(--gold);
            border-radius: 14px;
            overflow: hidden;
            background: #000;
            z-index: 20;
            pointer-events: none;
            will-change: transform;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }

        .photo-glow {
            border-color: #fff;
            box-shadow: 0 0 35px var(--gold);
            z-index: 100;
        }

        /* Video Feed */
        #video-container {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 90px;
            height: 120px;
            border-radius: 12px;
            border: 1.5px solid var(--gold);
            overflow: hidden;
            transform: scaleX(-1);
            z-index: 1000;
            background: #000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        #hand-pointer {
            position: fixed;
            width: 35px;
            height: 35px;
            background: radial-gradient(circle, var(--gold) 0%, transparent 80%);
            border: 1.5px solid white;
            border-radius: 50%;
            z-index: 9999;
            pointer-events: none;
            transform: translate(-50%, -50%);
            display: none;
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: var(--royal-bg);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay">
        <div class="w-12 h-12 border-4 border-gold border-t-transparent rounded-full animate-spin mb-4"></div>
        <h2 class="text-gold font-bold text-xl">جاري تحضير التجربة...</h2>
        <p class="text-white/40 text-sm mt-2 px-6">يرجى السماح بالوصول للكاميرا<br>لتحريك الصور بيديكِ</p>
    </div>

    <canvas id="bg-canvas"></canvas>
    <div id="hand-pointer"></div>
    <div id="video-container"><video id="webcam" autoplay playsinline class="w-full h-full object-cover"></video></div>

    <main class="h-screen flex flex-col items-center justify-center relative px-4">
        <div class="text-center mb-12 z-50 transition-all duration-700" id="header">
            <h1 class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-b from-white to-gold mb-2">مناسك</h1>
            <div class="inline-block bg-white/5 backdrop-blur-md px-6 py-2 rounded-full border border-white/10">
                <p id="instruction" class="text-gold text-sm font-bold tracking-wide uppercase">أغلقي يدك ✊ لفتح الصندوق</p>
            </div>
        </div>

        <div id="box-wrap" class="scene">
            <div class="box-3d" id="main-box">
                <div class="box-face front"></div>
                <div class="box-face back"></div>
                <div class="box-face right"></div>
                <div class="box-face left"></div>
                <div class="box-face top"></div>
                <div class="box-face bottom"></div>
            </div>
        </div>

        <div id="gallery" class="hidden absolute inset-0 overflow-hidden"></div>
    </main>

    <script>
        const photoSources = [
            "https://images.unsplash.com/photo-1531123897727-8f129e1688ce?q=80&w=500",
            "https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?q=80&w=500",
            "https://images.unsplash.com/photo-1494790108377-be9c29b29330?q=80&w=500",
            "https://images.unsplash.com/photo-1502323777036-f29e3972d82f?q=80&w=500",
            "https://images.unsplash.com/photo-1509460913899-515f1df34921?q=80&w=500",
            "https://images.unsplash.com/photo-1517841905240-472988babdf9?q=80&w=500",
            "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?q=80&w=500",
            "https://images.unsplash.com/photo-1534528741775-53994a69daeb?q=80&w=500"
        ];

        let appState = {
            isOpened: false,
            pointer: { x: window.innerWidth/2, y: window.innerHeight/2 },
            target: { x: window.innerWidth/2, y: window.innerHeight/2 },
            items: []
        };

        // Star Background
        const bgCanvas = document.getElementById('bg-canvas');
        const ctx = bgCanvas.getContext('2d');
        let stars = [];
        function initStars() {
            bgCanvas.width = window.innerWidth;
            bgCanvas.height = window.innerHeight;
            stars = Array.from({length: 40}, () => ({
                x: Math.random() * bgCanvas.width,
                y: Math.random() * bgCanvas.height,
                v: 0.3 + Math.random() * 0.4
            }));
        }
        function animateStars() {
            ctx.clearRect(0,0,bgCanvas.width,bgCanvas.height);
            ctx.fillStyle = '#fbbf24';
            stars.forEach(s => {
                s.y += s.v; if(s.y > bgCanvas.height) s.y = 0;
                ctx.beginPath(); ctx.arc(s.x, s.y, 0.8, 0, Math.PI*2); ctx.fill();
            });
            requestAnimationFrame(animateStars);
        }
        initStars(); animateStars();

        // Hands Processing
        const video = document.getElementById('webcam');
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        
        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 0,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        hands.onResults((res) => {
            document.getElementById('loading').style.opacity = '0';
            setTimeout(() => document.getElementById('loading').style.display = 'none', 500);

            if (res.multiHandLandmarks && res.multiHandLandmarks.length > 0) {
                const lm = res.multiHandLandmarks[0];
                const index = lm[8]; 
                const thumb = lm[4];
                const pinky = lm[20];

                appState.target.x = (1 - index.x) * window.innerWidth;
                appState.target.y = index.y * window.innerHeight;
                document.getElementById('hand-pointer').style.display = 'block';

                // Fist Detect (Distance thumb to pinky)
                const dist = Math.sqrt(Math.pow(thumb.x - pinky.x, 2) + Math.pow(thumb.y - pinky.y, 2));
                if (dist < 0.13 && !appState.isOpened) {
                    revealGallery();
                }
            }
        });

        function revealGallery() {
            appState.isOpened = true;
            document.getElementById('main-box').classList.add('box-open');
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#fbbf24', '#be123c'] });
            
            setTimeout(() => {
                document.getElementById('box-wrap').style.display = 'none';
                document.getElementById('gallery').classList.remove('hidden');
                document.getElementById('instruction').innerText = "وجهي سبابتكِ ☝️ نحو الصور";
                buildGallery();
            }, 1000);
        }

        function buildGallery() {
            const container = document.getElementById('gallery');
            photoSources.forEach((src, i) => {
                const el = document.createElement('div');
                el.className = 'floating-photo';
                el.innerHTML = `<img src="${src}" class="w-full h-full object-cover">`;
                container.appendChild(el);
                appState.items.push({
                    el: el,
                    x: Math.random() * (window.innerWidth - 110),
                    y: Math.random() * (window.innerHeight - 155),
                    vx: 0, vy: 0,
                    r: (Math.random() - 0.5) * 15
                });
            });
            loop();
        }

        function loop() {
            // Smooth pointer
            appState.pointer.x += (appState.target.x - appState.pointer.x) * 0.15;
            appState.pointer.y += (appState.target.y - appState.pointer.y) * 0.15;
            
            const ptr = document.getElementById('hand-pointer');
            ptr.style.left = `${appState.pointer.x}px`;
            ptr.style.top = `${appState.pointer.y}px`;

            appState.items.forEach(item => {
                const dx = appState.pointer.x - (item.x + 55);
                const dy = appState.pointer.y - (item.y + 77);
                const d = Math.sqrt(dx*dx + dy*dy);

                if (d < 280) {
                    const f = (280 - d) / 280;
                    item.vx += dx * f * 0.05;
                    item.vy += dy * f * 0.05;
                    item.el.classList.add('photo-glow');
                    item.el.style.transform = `translate(${item.x}px, ${item.y}px) rotate(${item.r}deg) scale(${1 + f * 0.5})`;
                } else {
                    item.el.classList.remove('photo-glow');
                    item.el.style.transform = `translate(${item.x}px, ${item.y}px) rotate(${item.r}deg) scale(1)`;
                }

                item.x += item.vx; item.y += item.vy;
                item.vx *= 0.92; item.vy *= 0.92;

                if (item.x < 0 || item.x > window.innerWidth - 110) item.vx *= -1;
                if (item.y < 0 || item.y > window.innerHeight - 155) item.vy *= -1;
            });

            requestAnimationFrame(loop);
        }

        const cam = new Camera(video, {
            onFrame: async () => { await hands.send({image: video}); },
            width: 480, height: 640
        });
        cam.start();

        window.addEventListener('resize', initStars);
    </script>
</body>
</html>

